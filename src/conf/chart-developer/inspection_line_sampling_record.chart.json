{
  "class": "",
  "graph_data": [
    {
      "datasource": {
        "class": "",
        "data": "function func(rawData, uiLoader) {\n  importPackage('moment')\n  var inData = JSON.parse(rawData)\n\n\n  var startDate = inData.startdate + ' 00:00:00'\n  var endDate = inData.enddate + ' 23:59:59'\n  var Process_code = inData.process_code\n\n\n  var db = new TSqlQueryV2(T_SQLCNT_POOL.getSqlDatabase())\n\n\n  try {\n    var where = [\n      \"qc.qc_start_time  BETWEEN '\" + startDate + \"' AND '\" + endDate + \"'\",\n      \"(qc.attr_data ->>'spot_test_flag') NOTNULL\",\n      \"class='iqs_form'\",\n    ]\n    if (Process_code != '') {\n      where.push(\"qc.process_code  ='\" + Process_code + \"'\")\n    }\n\n\n    var finishedPlanLst = db.selectArrayMap({\n      table:\n        'mes_prod_iqs qc ' +\n        \"LEFT JOIN mes_prod_order ORD01 ON ORD01. ID :: VARCHAR = qc.attr_data ->> 'prod_order_id' \",\n      field: [\n        'qc.partnumber', //物料编码\n        'ORD01.prod_order_no as uname', //生产任务号\n        'qc.qc_workshift ', // 检验人员\n        'qc.qc_start_time ', //抽样时间\n        \"qc.prod_json_data  ->> 'est_inspect_qty' as\" +\n          '\"prod_json_data.est_inspect_qty\"', //抽样预估数量\n        \"qc.prod_json_data  ->> 'scrap_qty' as\" + '\"prod_json_data.scrap_qty\"', // 不合格数量\n        'qc.result_json_data', //不良信息\n      ],\n      where: where,\n      order: 'qc.ID DESC',\n    })\n\n\n    //解析不良信息\n    for (tmp in finishedPlanLst) {\n      var jsonData = JSON.parse(finishedPlanLst[tmp]['result_json_data'])\n      if (jsonData.length != 0) {\n        for (temp in jsonData) {\n          var map = {}\n          var count = _.toString(jsonData[temp]['count'])\n          var key = jsonData[temp]['key']\n          map[key] = count\n          finishedPlanLst[tmp][key] = count\n        }\n      }\n    }\n\n\n    TLogger.writeLog(_.toString(finishedPlanLst))\n\n\n    var table = getTableViewStructure(startDate, endDate)\n    uiLoader.getObject('table').setHeaderItem(table.header_items)\n    uiLoader.getObject('table').setDataKeyList(table.data_keys)\n    return JSON.stringify({\n      table: finishedPlanLst,\n    })\n  } catch (e) {\n    TLogger.writeLog('error::' + _.toString(e))\n  }\n\n\n  function getTableViewStructure() {\n    var table = {\n      header_items: [\n        {\n          name: 'uname',\n          display: '生产任务号',\n          displayRole: '$uname',\n          resizeMode: 'ResizeToContents',\n        },\n        {\n          name: 'partnumber',\n          display: '物料编码',\n          displayRole: '$partnumber',\n          resizeMode: 'ResizeToContents',\n        },\n        {\n          name: 'lot_no',\n          display: '批次',\n          displayRole: '$lot_no',\n          resizeMode: 'ResizeToContents',\n        },\n        {\n          name: 'qc_start_time',\n          display: '抽样时间',\n          displayRole: '$qc_start_time',\n          resizeMode: 'ResizeToContents',\n        },\n        {\n          name: 'prod_json_data.est_inspect_qty',\n          display: '抽样预估数量',\n          displayRole: '$prod_json_data.est_inspect_qty',\n          resizeMode: 'ResizeToContents',\n        },\n        {\n          name: 'prod_json_data.scrap_qty',\n          display: '不合格量',\n          displayRole: '$prod_json_data.scrap_qty',\n          resizeMode: 'ResizeToContents',\n        },\n        {\n          name: 'qc_workshift',\n          display: '检验人员',\n          displayRole: '$qc_workshift',\n          resizeMode: 'ResizeToContents',\n        },\n        {\n          name: 'result_json_data.huashang',\n          display: '划伤',\n          displayRole: '$huashang',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.bianxing',\n          display: '变形',\n          displayRole: '$bianxing',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.fahua',\n          display: '发花',\n          displayRole: '$fahua',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.fabai',\n          display: '发白',\n          displayRole: '$fabai',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.fahuang',\n          display: '发黄',\n          displayRole: '$fahuang',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.quekou',\n          display: '缺口',\n          displayRole: '$quekou',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.quekou',\n          display: '电镀实验',\n          displayRole: '$diandushiyan',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.huangbanfanxi',\n          display: '黄斑返洗',\n          displayRole: '$huangbanfanxi',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.cailiao',\n          display: '材料',\n          displayRole: '$cailiao',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.yayin',\n          display: '压印',\n          displayRole: '$yayin',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.lailiaohuashang',\n          display: '来料划伤',\n          displayRole: '$lailiaohuashang',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.duoliao/queliao',\n          display: '多料/缺料',\n          displayRole: '$duoliao/queliao',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.chongyabianxing',\n          display: '冲压变形',\n          displayRole: '$chongyabianxing',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.mujuyin',\n          display: '模具印',\n          displayRole: '$mujuyin',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.fushi',\n          display: '腐蚀',\n          displayRole: '$fushi',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.liewen/kailie',\n          display: '裂纹/开裂',\n          displayRole: '$liewen/kailie',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n        {\n          name: 'result_json_data.maoci',\n          display: '毛刺',\n          displayRole: '$maoci',\n          resizeMode: 'ResizeToContents',\n          backgroundRole: 'yellow',\n        },\n      ],\n      data_keys: [\n        'uname',\n        'partnumber',\n        'lot_no',\n        'qc_start_time',\n        'prod_json_data.est_inspect_qty',\n        'prod_json_data.scrap_qty',\n        'qc_workshift',\n        'result_json_data',\n        'huashang',\n        'bianxing',\n        'fahua',\n        'fabai',\n        'fahuang',\n        'quekou',\n        'diandushiyan',\n        'huangbanfanxi',\n        'cailiao',\n        'yayin',\n        'lailiaohuashang',\n        'duoliao/queliao',\n        'chongyabianxing',\n        'mujuyin',\n        'fushi',\n        'liewen/kailie',\n        'maoci',\n      ],\n    }\n\n\n    return table\n  }\n}\n\n",
        "name": "inspection_line_sampling_record",
        "parameter": "startdate,enddate,process_code",
        "remark": "检验线抽检记录"
      },
      "graph": {
        "class": "",
        "data": "[\n    {\n        name: 'info',\n        type: 'VBoxLayout',\n        property: { spacing: 0, margin: 0 },\n        child: [\n            {\n                name: 'table',\n                type: 'TreeView',\n                property: {},\n                pack: {},\n                initCallback: function (obj) {\n                },\n                setter: function (obj, value, self) {\n                  if (value != null) {\n                      obj.loadTreeData(value);\n                  } else {\n                    obj.loadTreeData([]);\n                  }\n              }\n            }\n        ]\n    }\n]\n\n\n",
        "dynamic": 1,
        "name": "inspection_line_sampling_record",
        "parameter_remark": "",
        "remark": "检验线抽检记录"
      }
    }
  ],
  "graph_layout": {
    "child": [
      {
        "name": "inspection_line_sampling_record",
        "pack": {
          "columnSpan": 1,
          "fromColumn": 0,
          "fromRow": 0,
          "rowSpan": 2
        },
        "type": "uiloader"
      }
    ],
    "type": "gridlayout"
  },
  "name": "inspection_line_sampling_record",
  "parameter_list": "function func(self) {\n  importPackage('moment')\n  return [\n    {\n      name: 'widget',\n      type: 'Widget',\n      property: {},\n      child: [\n        {\n          name: 'scrollarea',\n          type: 'ScrollArea',\n          property: { widget_resizable: true, frame_shape: 'QFrame::NoFrame' },\n          pack: {},\n          child: {\n            name: 'gridlayout',\n            type: 'GridLayout',\n            property: {},\n            pack: {},\n            child: [\n              // 开始时间\n              {\n                name: 'startdatelbl',\n                type: 'Label',\n                property: {\n                  text: '开始时间',\n                  alignment: 'Qt::AlignLeft',\n                  size_policy: 'Fixed,Fixed',\n                },\n                pack: { row: 0, column: 0 },\n              },\n              {\n                name: 'startdate',\n                type: 'DateEdit',\n                title: self.ttr('Start Date'),\n                pack: { row: 0, column: 1 },\n                initCallback: function (obj, self) {\n                  obj.setData('value', APP.getToday())\n                },\n                validate: function (obj, val, title, moments, self) {\n                  var endDateStr = this.getValue('enddate')\n                  endDateStr = String(endDateStr).replace(/-/g, '/')\n                  val = String(val).replace(/-/g, '/')\n                  var endDate = new Date(endDateStr)\n                  var startDate = new Date(val)\n                  if (val.trim() == '') {\n                    return [title + self.ttr(' can not be null!'), 'Error']\n                  } else if (startDate > endDate) {\n                    return [\n                      self.ttr('Start date can not be later than end date!'),\n                      'Error',\n                    ]\n                  }\n                },\n              },\n              // 结束时间\n              {\n                name: 'endtdatelbl',\n                type: 'Label',\n                property: {\n                  text: '结束时间',\n                  alignment: 'Qt::AlignLeft',\n                  size_policy: 'Fixed,Fixed',\n                },\n                pack: { row: 0, column: 2 },\n              },\n              {\n                name: 'enddate',\n                type: 'DateEdit',\n                title: self.ttr('End Date'),\n                pack: { row: 0, column: 3 },\n                validate: 'NOTNULL',\n                initCallback: function (obj, self) {\n                  obj.setData('value', APP.getToday())\n                },\n              },\n\n\n              //工序名称\n              {\n                name: 'Process_code',\n                type: 'Label',\n                property: {\n                  text: '检验工序',\n                  alignment: 'Qt::AlignLeft',\n                  size_policy: 'Fixed,Fixed',\n                },\n                pack: { row: 0, column: 4 },\n              },\n              {\n                name: 'process_code',\n                type: 'ComboBox',\n                title: self.ttr('Process_code'),\n                property: {\n                  item_list: [\n                    { name: 'GF003_03', text: '清洗' },\n                    { name: 'GF006_03', text: '钝化' },\n                    { name: 'GF002_03', text: 'EN2' },\n                    { name: 'GF007_03', text: '氧化' },\n                    { name: 'GF022_03', text: '镀银' },\n                  ],\n                  minimum_width: 260,\n                },\n                pack: { row: 0, column: 5 },\n              },\n            ],\n          },\n        },\n      ],\n    },\n  ]\n}\n\n",
  "remark": "检验线抽检记录"
}