[TOC]

# topsin.wechat
`topsin.wechat`企业微信自建应用后台消息接收加解密。

##方法

### setup(token, aesKey, rcvId)
初始化环境

**参数**
- **token** `String` : 自建应用后台页面生成的token
- **aesKey** `String`: 自建应用后台页面生成的aes key
- **rcvId**  `String`:  根据情况有不同的含义，这里指后台页面上的corpid （企业ID）


**返回**


**示例**

```javascript
var wechat = require('wechat');

var token = 'o1EmsfXUoWHqlYjLllTI2';
var aeskey = 'QR9WtkxQBnwpmy2LAJbfprAFJqEq2tJETmXdijtg6PW';
var corpid = 'ww9dd66433fac893ee';

wechat.setup(token, aeskey, corpid);
```

------

### verifyUrl(signature, timeStamp, nonce, echoStr)
在设置接收企业微信后台消息的API时，微信后台发送GET请求校验此API是否可用。
此函数封装了解析请求和构造回复的操作。
此函数的参数均为GET请求的query参数

**参数**
- **signature** `String` : 签名 
- **timeStamp** `String` : 时间戳
- **nonce** `String`: 随机数
-  **echoStr** `String`: 回射字符串

**返回**
- `Map` :  错误代码、数据和错误消息的映射，如：

```
{
    "code": 0,
    "data": "whatever",
    "msg": "Ok"
}
```

所有可能的错误代码和消息的映射如下：
```
0  => "Ok",
1  => "Validate Signature Error",
2  => "Parse XML Error",
3  => "Illegal AES Key",
4  => "Validate Corpid Error",
5  => "Encrypt AES Error",
6  => "Decrypt AES Error",
7  => "Illegal Buffer",
8  => "Encode Base64 Error",
9  => "Decode Base64 Error",
10 => "Generate Return XML Error"
```

----

### decryptMsg(signature, timeStamp, nonce, postData)
解密微信后台推送的回复消息

**参数**
- **signature** `String`： 消息签名
- **timeStamp** `String`：时间戳
- **nonce** `String`：随机数
- **postData** `String`：消息数据

**返回**
同 `verifyUrl`

### encryptMsg(reply, timeStamp, nonce)
主动回复微信后台时需要加密消息

**参数**
- **reply** `String`： 需要加密的消息
- **timeStamp** `String`：时间戳
- **nonce** `String`：随机数

**返回**
同 `verifyUrl`

### getXmlFiled(data, field)
获取解密后消息内容的辅助函数

**参数**
- **data** `String`： 解密后的消息
- **field**  `String`：需要获取值的字段名称

**返回**

- `String`：错误返回空字符串，否则该字段的值